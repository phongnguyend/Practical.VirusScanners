using Amazon.S3;
using Amazon.S3.Model;
using Amazon.S3.Transfer;
using AwsGuardDutyMalwareProtectionForS3Scanner;
using Microsoft.Extensions.Configuration;

var configuration = new ConfigurationBuilder()
    .SetBasePath(Directory.GetCurrentDirectory())
    .AddJsonFile("appsettings.json", optional: false, reloadOnChange: true)
    .AddUserSecrets<Program>()
    .Build();

var options = new AmazonOptions();
configuration.GetSection("AwsS3Storage").Bind(options);

var client = options.CreateAmazonS3Client();

var fileName = configuration["Scanner:FilePath"]!;

// Get file size for wait time calculation
var fileInfo = new FileInfo(fileName);
double fileSizeInMB = fileInfo.Length / (1024.0 * 1024.0);

// Calculate first wait time based on file size: base 10s + 1s per MB (max 5min)
int firstWaitTime = Math.Min(10000 + (int)Math.Max(0, (fileSizeInMB - 1) * 1000), 300000);

Console.WriteLine($"File size: {fileSizeInMB:F2} MB, initial wait time: {firstWaitTime / 1000}s");

Console.WriteLine($"Uploading {fileName} to Aws S3 Storage at {DateTime.Now}...");

using var stream = File.OpenRead(fileName);
var fileTransferUtility = new TransferUtility(client);

var uploadRequest = new TransferUtilityUploadRequest
{
    InputStream = stream,
    Key = options.Path + fileInfo.Name,
    BucketName = options.BucketName,
    CannedACL = S3CannedACL.NoACL,
};

var clientRequestedTime = DateTimeOffset.Now.ToString();
uploadRequest.Metadata["client-requested-time"] = clientRequestedTime;

await fileTransferUtility.UploadAsync(uploadRequest);

Console.WriteLine($"Uploaded {fileName} to Aws S3 Storage at {DateTime.Now}...");

int totalWaitTime = 0;

await Task.Delay(firstWaitTime);
totalWaitTime += firstWaitTime;

var taggingResponse = await client.GetObjectTaggingAsync(new GetObjectTaggingRequest
{
    BucketName = options.BucketName,
    Key = uploadRequest.Key
});

var tags = taggingResponse.Tagging;

int interval = 5000; // Polling interval in milliseconds

while (tags == null || !tags.Any(x => x.Key == "GuardDutyMalwareScanStatus")) // Wait until tags are available
{
    await Task.Delay(interval); // Polling interval
    taggingResponse = await client.GetObjectTaggingAsync(new GetObjectTaggingRequest
    {
        BucketName = options.BucketName,
        Key = uploadRequest.Key
    });

    tags = taggingResponse.Tagging;

    totalWaitTime += interval;
}

var scanResultTag = tags.FirstOrDefault(x => x.Key == "GuardDutyMalwareScanStatus");
var scanResult = scanResultTag?.Value ?? string.Empty;

Console.WriteLine($"Scan Result: {scanResultTag?.Value} at {DateTime.Now}. Total Wait Time: {totalWaitTime / 1000} seconds");

if (scanResult.Equals(ScanResults.THREATS_FOUND, StringComparison.OrdinalIgnoreCase))
{
    Console.WriteLine("⚠️ File is infected!");
    // Example action: quarantine, delete, block access
}
else if (scanResult.Equals(ScanResults.NO_THREATS_FOUND, StringComparison.OrdinalIgnoreCase))
{
    Console.WriteLine("✅ File is clean.");
}
else
{
    Console.WriteLine("⏳ Scan not finished or unknown result.");
}

public class ScanResults
{
    public const string NO_THREATS_FOUND = "NO_THREATS_FOUND";
    public const string THREATS_FOUND = "THREATS_FOUND";
    public const string UNSUPPORTED = "UNSUPPORTED";
    public const string ACCESS_DENIED = "ACCESS_DENIED";
    public const string FAILED = "FAILED";
}
